name: Test SonarQube Evidence Integration

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-sonar-evidence:
    runs-on: mishas-mac
    permissions:
      contents: read
      id-token: write
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_URL: ${{ secrets.SONAR_URL }}
      JFROG_URL: ${{ secrets.JFROG_URL }}
      JFROG_CLI_LOG_LEVEL: DEBUG
      JFROG_CLI_KEY_ALIAS: ${{ vars.JFROG_CLI_KEY_ALIAS }}
      JFROG_CLI_SIGNING_KEY: ${{ secrets.JFROG_CLI_SIGNING_KEY }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: ${{ env.JFROG_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JFROG_ACCESS_TOKEN }}
        with:
          custom-server-id: evidence-prod
          version: 2.78.10

      - name: Test JFrog Connection
        run: |
          jf c show
          jf c use evidence-prod
          jf rt ping
          jf -v

      - name: Test SonarQube Evidence - Passing Quality Gate
        env:
          SONAR_REPORT_TASK_FILE: /tmp/report-task-pass.txt
        run: |
          echo "Creating report-task.txt for passing quality gate..."
          cat > $SONAR_REPORT_TASK_FILE << EOF
          projectKey=js-test
          serverUrl=${{ secrets.SONAR_URL }}
          ceTaskId=${{ secrets.SONAR_TASK_UUID_PASS }}
          EOF
          
          echo "Testing Passing Quality Gate (main branch)..."
          jf evd create \
            --integration=sonar \
            --subject-repo-path=misha-docker-local/hello-world/92f8f121555eb75ba76b2ba43d9740d9928adfd3/manifest.json \
            --key="${{ secrets.JFROG_CLI_SIGNING_KEY }}" \
            --key-alias="${{ vars.JFROG_CLI_KEY_ALIAS }}" \
            --server-id=evidence-prod
          
          echo "✅ Passing Quality Gate test successful"

      - name: Test SonarQube Evidence - Failing Quality Gate
        env:
          SONAR_REPORT_TASK_FILE: /tmp/report-task-fail.txt
        run: |
          echo "Creating report-task.txt for failing quality gate..."
          cat > $SONAR_REPORT_TASK_FILE << EOF
          projectKey=js-test
          serverUrl=${{ secrets.SONAR_URL }}
          ceTaskId=${{ secrets.SONAR_TASK_UUID_FAIL }}
          EOF
          
          echo "Testing Failing Quality Gate (PR)..."
          # This should succeed in creating evidence even with a failing quality gate
          jf evd create \
            --integration=sonar \
            --subject-repo-path=misha-docker-local/hello-world/92f8f121555eb75ba76b2ba43d9740d9928adfd3/manifest.json \
            --key="${{ secrets.JFROG_CLI_SIGNING_KEY }}" \
            --key-alias="${{ vars.JFROG_CLI_KEY_ALIAS }}" \
            --server-id=evidence-prod
          
          echo "✅ Failing Quality Gate test successful"
